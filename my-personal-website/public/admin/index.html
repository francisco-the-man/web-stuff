<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager - Content Management System</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Custom styles for better CMS experience */
    :root {
      --primary-color: #3F51B5;
      --secondary-color: #3982F7;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --error-color: #F44336;
    }
    
    body {
      font-family: 'IBM Plex Mono', monospace;
    }
    
    /* Make the CMS interface wider */
    .nc-app-main {
      max-width: 1400px !important;
      margin: 0 auto !important;
    }
    
    /* Deploy Test Banner - ADDED MAY 21st */
    .deploy-test-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #4CAF50;
      color: white;
      text-align: center;
      padding: 10px;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Improved image preview size */
    .nc-imageControl-imageWrapper {
      max-height: 300px;
      overflow: hidden;
    }
    
    /* Style the header */
    .nc-appHeader-main {
      background: var(--primary-color) !important;
    }
    
    /* Custom button styles */
    .nc-button.nc-button-primary {
      background-color: var(--primary-color) !important;
    }
    
    /* Preview styles */
    .project-preview-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
    }
    
    .project-preview-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    
    .project-preview-image {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .project-preview-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .project-preview-meta div {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .project-preview-description {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
  <!-- Import IBM Plex Mono font -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- DEPLOY TEST BANNER - MAY 21, 2024 -->
  <div class="deploy-test-banner">ðŸš€ DEPLOY TEST: MAY 21, 2024 - This banner confirms you're viewing the latest version</div>
  
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <!-- Initialize the CMS -->
  <script>
    // Log versions and configuration for debugging
    console.log('Netlify CMS Admin - May 21, 2024 Version');
    console.log('Browser:', navigator.userAgent);
    
    // Global error handling for CMS
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('CMS Error:', message, error);
      alert('CMS Error: ' + message);
      return true;
    };

    // Direct override of the problematic Immutable.js methods
    (function patchImmutableJS() {
      console.log('Initializing admin with Immutable.js patches');
      
      // Create a safer getIn implementation
      function safeGetIn(obj, path, defaultValue) {
        try {
          if (!obj) return defaultValue;
          
          // Convert path to array if it's not already
          const keys = Array.isArray(path) ? path : path.split('.');
          let current = obj;
          
          for (const key of keys) {
            if (current === undefined || current === null) {
              return defaultValue;
            }
            
            // Handle both object properties and Map/Record methods
            if (typeof current.get === 'function') {
              current = current.get(key);
            } else {
              current = current[key];
            }
          }
          
          return current === undefined ? defaultValue : current;
        } catch (e) {
          console.error('SafeGetIn Error:', e);
          return defaultValue;
        }
      }
      
      // Enhanced safe wrapper for Immutable objects
      window.fixImmutableIssue = function(entry) {
        // If entry is null or undefined, return a safe object
        if (!entry) {
          console.warn('Entry is null or undefined');
          return {
            getIn: (path, defaultValue) => defaultValue,
            toJS: () => ({}),
            data: {}
          };
        }
        
        // If entry already has getIn method, wrap it with our safe version
        if (typeof entry.getIn === 'function') {
          const originalGetIn = entry.getIn;
          entry.getIn = function(path, defaultValue) {
            try {
              return originalGetIn.call(entry, path, defaultValue);
            } catch (error) {
              console.warn('Error in original getIn, using safe fallback', error);
              return safeGetIn(entry.toJS ? entry.toJS() : entry, path, defaultValue);
            }
          };
          return entry;
        }
        
        // If entry doesn't have getIn, create a wrapper object
        console.warn('Entry missing getIn method, creating wrapper');
        return {
          original: entry,
          getIn: function(path, defaultValue) {
            return safeGetIn(entry, path, defaultValue);
          },
          toJS: function() {
            return entry && typeof entry.toJS === 'function' ? entry.toJS() : 
                  (typeof entry === 'object' ? entry : {});
          },
          data: entry.data || {}
        };
      };
      
      // Override slug handling - this is critical
      window.createSlug = function(collection, entry) {
        try {
          console.log('Creating slug for entry', entry);
          
          // Explicitly extract fileName from entry data
          let fileName = '';
          
          // Try multiple ways to get the fileName
          try {
            if (entry && entry.getIn) {
              fileName = entry.getIn(['data', 'fileName'], '');
            } else if (entry && entry.data) {
              fileName = entry.data.fileName || '';
            } else if (entry && entry.toJS) {
              const data = entry.toJS();
              fileName = data.data ? data.data.fileName : '';
            }
          } catch (err) {
            console.error('Error accessing entry data', err);
          }
          
          // Log and return the slug
          console.log('Generated slug from fileName:', fileName);
          
          if (!fileName || fileName.trim() === '') {
            console.warn('No fileName found, using timestamp');
            return 'project-' + new Date().getTime().toString();
          }
          
          return String(fileName).trim();
        } catch (error) {
          console.error('Slug creation error:', error);
          return 'error-slug-' + new Date().getTime().toString();
        }
      };
    })();

    // Initialize Netlify CMS with error handling
    try {
      // Configure the CMS before init
      CMS.init({
        config: {
          load_config_file: true
        }
      });
      console.log('CMS initialized successfully');
      
      // Register a custom preview template for projects
      CMS.registerPreviewTemplate('projects', ({ entry }) => {
        // Use our wrapper to handle potential Immutable.js errors
        entry = window.fixImmutableIssue(entry);
        
        let data;
        try {
          data = entry.getIn(['data'], {});
          data = typeof data.toJS === 'function' ? data.toJS() : data;
          console.log('Preview data:', data);
        } catch (error) {
          console.error('Error getting entry data:', error);
          data = {};
        }
        
        try {
          // Validate required fields based on type
          if (data.type === 'written' && !data.authorNames) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Written projects require author names. Please add at least one author.</p>
              </div>
            `;
          }
          if (data.type === 'computational' && !data.repoLink) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Computational projects require a repository link. Please add a valid repository URL.</p>
              </div>
            `;
          }
          
          // Preview the project data with improved styling
          return `
            <div class="project-preview-container">
              <div class="project-preview-header">
                <h1 style="margin-top: 0; color: #333;">${data.projectTitle || 'Untitled Project'}</h1>
                <p style="color: #666; margin-bottom: 0;">
                  <strong>Tab Label:</strong> ${data.fileName || 'Unnamed Tab'}
                </p>
              </div>
              
              <!-- Project Folder Preview -->
              <div style="position: relative; width: 100%; margin: 30px 0; border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #f9f9f9;">
                <div style="position: absolute; top: -15px; left: 40px; background: #fff; padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;">
                  ${data.fileName || 'Unnamed Tab'}
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                  <h3 style="text-transform: uppercase; font-weight: bold; margin-bottom: 15px;">${data.projectTitle || 'Untitled Project'}</h3>
                  
                  <div style="width: 80%; margin: 0 auto 15px auto;">
                    ${data.projectImg ? 
                      `<img src="${data.projectImg}" alt="${data.projectTitle}" style="width: 100%; height: 140px; object-fit: cover; border: 1px solid #ddd;" />` : 
                      '<div style="width: 100%; height: 140px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;"><span>No Image Selected</span></div>'
                    }
                  </div>
                  
                  <p style="font-size: 14px; margin-bottom: 20px; min-height: 60px; line-height: 1.5;">
                    ${data.description || 'No description provided.'}
                  </p>
                  
                  <div style="margin-top: auto; text-align: center; padding-top: 10px; border-top: 1px solid #eee;">
                    ${data.type === 'written' ? 
                      `<p style="font-style: italic; font-size: 12px;">written by: ${data.authorNames || 'unknown'}</p>` : 
                      `<p style="font-size: 12px;"><span style="display: inline-block; vertical-align: middle; margin-right: 5px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12C2 16.418 4.865 20.166 8.84 21.489C9.34 21.579 9.52 21.273 9.52 21.012C9.52 20.775 9.512 20.136 9.508 19.3C6.726 19.91 6.14 17.861 6.14 17.861C5.684 16.726 5.029 16.421 5.029 16.421C4.121 15.765 5.098 15.777 5.098 15.777C6.101 15.849 6.63 16.844 6.63 16.844C7.521 18.327 8.97 17.908 9.54 17.657C9.628 17.05 9.883 16.632 10.16 16.419C7.93 16.202 5.582 15.353 5.582 11.613C5.582 10.52 6.002 9.628 6.65 8.933C6.55 8.684 6.178 7.658 6.75 6.337C6.75 6.337 7.587 6.073 9.496 7.431C10.295 7.211 11.152 7.102 12 7.098C12.848 7.102 13.705 7.211 14.504 7.431C16.413 6.073 17.25 6.337 17.25 6.337C17.822 7.658 17.45 8.684 17.35 8.933C17.998 9.628 18.418 10.52 18.418 11.613C18.418 15.363 16.068 16.2 13.836 16.413C14.185 16.685 14.512 17.227 14.512 18.043C14.512 19.207 14.499 20.684 14.499 21.012C14.499 21.275 14.677 21.584 15.186 21.487C19.158 20.16 22 16.416 22 12C22 6.477 17.523 2 12 2Z"></path></svg></span> <a href="${data.repoLink || '#'}" style="color: #3982F7; text-decoration: underline;">code</a></p>`
                    }
                  </div>
                </div>
              </div>
              
              <!-- Project Field Details -->
              <div class="project-preview-meta">
                <div>
                  <strong>Type:</strong> ${data.type || 'Not specified'}<br>
                  <strong>Category:</strong> ${data.category || 'Not specified'}<br>
                  <strong>Position:</strong> ${data.position || 'Not specified'}
                </div>
                <div>
                  ${data.authorNames ? `<strong>Authors:</strong> ${data.authorNames}<br>` : ''}
                  ${data.repoLink ? `<strong>Repository:</strong> <a href="${data.repoLink}" target="_blank">${data.repoLink}</a><br>` : ''}
                </div>
              </div>
              
              <div style="margin-top: 15px; padding: 10px; background: #E8F5E9; border-radius: 4px; font-size: 0.9em;">
                <p style="margin: 0; color: #2E7D32;">
                  <strong>Preview Note:</strong> This project will appear in a folder styled interface on the 
                  ${data.category === 'both' ? 'Computer and Research' : data.category} page.
                </p>
              </div>
            </div>
          `;
        } catch (error) {
          return `<div style="color: red; padding: 20px;">Error rendering preview: ${error.message}</div>`;
        }
      });

      // Add Netlify CMS hooks for validation and slug customization 
      window.CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          console.log('Handling preSave event', entry);
          
          // Apply our Immutable fix
          entry = window.fixImmutableIssue(entry);
          
          try {
            // Get and log entry data safely
            const data = entry.getIn(['data'], {});
            const jsData = typeof data.toJS === 'function' ? data.toJS() : data;
            console.log('Saving entry data:', jsData);
            
            // Validate required fields
            if (!jsData.fileName) {
              return 'File Name is required. Please provide a tab name.';
            }
            
            if (jsData.type === 'written' && !jsData.authorNames) {
              return 'Written projects require author names. Please add at least one author.';
            }
            
            if (jsData.type === 'computational' && !jsData.repoLink) {
              return 'Computational projects require a repository link. Please add a valid repository URL.';
            }
            
            return true; // Allow the save to proceed
          } catch (error) {
            console.error('Error handling preSave:', error);
            return 'Error processing form data. Please try again.';
          }
        },
      });

      // Add helpful information to the CMS interface
      document.addEventListener('DOMContentLoaded', function() {
        // Insert a helpful note about the current configuration
        setTimeout(() => {
          try {
            const content = document.querySelector('.nc-app-main .nc-app-content');
            if (content) {
              const infoBox = document.createElement('div');
              infoBox.style.margin = '10px 20px';
              infoBox.style.padding = '10px';
              infoBox.style.background = '#E8F5E9';
              infoBox.style.borderRadius = '4px';
              infoBox.innerHTML = `
                <h3 style="margin-top: 0;">Project Management Details</h3>
                <p><strong>Projects are saved to:</strong> src/_projects/[filename].json</p>
                <p><strong>Images are saved to:</strong> public/projects/images/</p>
                <p><strong>File Name field</strong> is used to generate both the JSON filename and the folder tab label.</p>
                <p><strong>Deploy version:</strong> May 21, 2024 - Enhanced slug handling</p>
              `;
              
              // Insert at the beginning of the content
              if (content.firstChild) {
                content.insertBefore(infoBox, content.firstChild);
              } else {
                content.appendChild(infoBox);
              }
            }
            
            const header = document.querySelector('.nc-appHeader-content');
            if (header) {
              const infoButton = document.createElement('button');
              infoButton.className = 'nc-button';
              infoButton.innerHTML = 'Help';
              infoButton.style.marginLeft = '10px';
              infoButton.addEventListener('click', () => {
                alert('Project Management Tips:\n\nâ€¢ Changes made here are saved to your Git repository\nâ€¢ To see changes on your site, you must publish them\nâ€¢ File Name field is used for the folder tab display\nâ€¢ Projects can be reordered in the admin interface\nâ€¢ Check the console (F12) for additional error information if issues occur');
              });
              header.appendChild(infoButton);
              
              // Add debugging info button
              const debugButton = document.createElement('button');
              debugButton.className = 'nc-button';
              debugButton.innerHTML = 'Debug Info';
              debugButton.style.marginLeft = '10px';
              debugButton.style.background = '#FF9800';
              debugButton.addEventListener('click', () => {
                console.log('CMS Config:', CMS.getConfig());
                alert('Debug information has been output to the browser console.\nPress F12 to view.');
              });
              header.appendChild(debugButton);
            }
          } catch (e) {
            console.error('Error adding help elements:', e);
          }
        }, 1000);
      });
    } catch (error) {
      console.error('CMS initialization error:', error);
      alert('Failed to initialize CMS: ' + error.message);
    }
  </script>
</body>
</html> 