<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager - Content Management System</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    // Enhanced Identity handling
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        } else {
          console.log("User is already logged in");
        }
      });
    } else {
      console.warn("Netlify Identity not loaded");
    }
  </script>
  <style>
    /* Custom styles for better CMS experience */
    :root {
      --primary-color: #3F51B5;
      --secondary-color: #3982F7;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --error-color: #F44336;
    }
    
    body {
      font-family: 'IBM Plex Mono', monospace;
    }
    
    /* Make the CMS interface wider */
    .nc-app-main {
      max-width: 1400px !important;
      margin: 0 auto !important;
    }
    
    /* Improve image preview size */
    .nc-imageControl-imageWrapper {
      max-height: 300px;
      overflow: hidden;
    }
    
    /* Style the header */
    .nc-appHeader-main {
      background: var(--primary-color) !important;
    }
    
    /* Custom button styles */
    .nc-button.nc-button-primary {
      background-color: var(--primary-color) !important;
    }
    
    /* Preview styles */
    .project-preview-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
    }
    
    .project-preview-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    
    .project-preview-image {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .project-preview-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .project-preview-meta div {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .project-preview-description {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
  <!-- Import IBM Plex Mono font -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <!-- Initialize the CMS -->
  <script>
    // Global error handling for CMS
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('CMS Error:', message, error);
      alert('CMS Error: ' + message);
      return true;
    };

    // Polyfill for Immutable.js methods to fix getIn errors
    class SafeMap {
      constructor(data) {
        this.data = data || {};
      }
      
      getIn(path, defaultValue) {
        try {
          let current = this.data;
          for (const key of path) {
            if (current === undefined || current === null) {
              return defaultValue;
            }
            current = current[key];
          }
          return current === undefined ? defaultValue : current;
        } catch (e) {
          console.error('Error in getIn:', e);
          return defaultValue;
        }
      }
      
      toJS() {
        return this.data;
      }
    }
    
    // Patch entry handling methods
    window.fixImmutableIssue = function(entry) {
      if (!entry || !entry.getIn) {
        console.warn('Entry object missing getIn method, creating safe wrapper');
        return new SafeMap(entry);
      }
      return entry;
    };

    // Fix Slug Formatter Issue
    try {
      // This patches the specific slug formatter function that's causing errors
      const originalSlugFormatter = window.decodeURIComponent(
        document.querySelector('script[src*="netlify-cms"]').src
      ).match(/slugFormatter.*?\}/)[0];
      
      if (originalSlugFormatter) {
        // Create a safer version that doesn't rely on Immutable.js
        const safeSlugFormatter = function(collection, entry) {
          try {
            // Get fileName value either directly or via the polyfill
            const fileName = entry.getIn ? entry.getIn(['data', 'fileName']) : 
                           (entry.data && entry.data.fileName ? entry.data.fileName : '');
            
            // Return the fileName as the slug, or a timestamp if not available
            return fileName ? fileName.toString() : new Date().getTime().toString();
          } catch (error) {
            console.error('Error in slug formatter:', error);
            return new Date().getTime().toString(); // Fallback to timestamp
          }
        };
        
        // Override the broken slugFormatter method in Netlify CMS
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            // Ensure the entry has a fileName before saving
            const data = entry.toJS ? entry.toJS().data : (entry.data || {});
            if (!data.fileName) {
              return 'Please provide a fileName before saving';
            }
            return true;
          }
        });
      }
    } catch (error) {
      console.error('Failed to patch slug formatter:', error);
    }

    // Initialize Netlify CMS with error handling
    try {
      // Configure the CMS before init
      CMS.init({
        config: {
          load_config_file: true
        }
      });
      console.log('CMS initialized successfully');
      
      // Register a custom preview template for projects
      CMS.registerPreviewTemplate('projects', ({ entry }) => {
        // Use our wrapper to handle potential Immutable.js errors
        entry = window.fixImmutableIssue(entry);
        
        let data;
        try {
          data = entry.getIn(['data'], {}).toJS();
          console.log('Preview data:', data);
        } catch (error) {
          console.error('Error getting entry data:', error);
          data = {};
        }
        
        try {
          // Validate required fields based on type
          if (data.type === 'written' && !data.authorNames) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Written projects require author names. Please add at least one author.</p>
              </div>
            `;
          }
          if (data.type === 'computational' && !data.repoLink) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Computational projects require a repository link. Please add a valid repository URL.</p>
              </div>
            `;
          }
          
          // Preview the project data with improved styling
          return `
            <div class="project-preview-container">
              <div class="project-preview-header">
                <h1 style="margin-top: 0; color: #333;">${data.projectTitle || 'Untitled Project'}</h1>
                <p style="color: #666; margin-bottom: 0;">
                  <strong>Tab Label:</strong> ${data.fileName || 'Unnamed Tab'}
                </p>
              </div>
              
              <!-- Project Folder Preview -->
              <div style="position: relative; width: 100%; margin: 30px 0; border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #f9f9f9;">
                <div style="position: absolute; top: -15px; left: 40px; background: #fff; padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;">
                  ${data.fileName || 'Unnamed Tab'}
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                  <h3 style="text-transform: uppercase; font-weight: bold; margin-bottom: 15px;">${data.projectTitle || 'Untitled Project'}</h3>
                  
                  <div style="width: 80%; margin: 0 auto 15px auto;">
                    ${data.projectImg ? 
                      `<img src="${data.projectImg}" alt="${data.projectTitle}" style="width: 100%; height: 140px; object-fit: cover; border: 1px solid #ddd;" />` : 
                      '<div style="width: 100%; height: 140px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;"><span>No Image Selected</span></div>'
                    }
                  </div>
                  
                  <p style="font-size: 14px; margin-bottom: 20px; min-height: 60px; line-height: 1.5;">
                    ${data.description || 'No description provided.'}
                  </p>
                  
                  <div style="margin-top: auto; text-align: center; padding-top: 10px; border-top: 1px solid #eee;">
                    ${data.type === 'written' ? 
                      `<p style="font-style: italic; font-size: 12px;">written by: ${data.authorNames || 'unknown'}</p>` : 
                      `<p style="font-size: 12px;"><span style="display: inline-block; vertical-align: middle; margin-right: 5px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12C2 16.418 4.865 20.166 8.84 21.489C9.34 21.579 9.52 21.273 9.52 21.012C9.52 20.775 9.512 20.136 9.508 19.3C6.726 19.91 6.14 17.861 6.14 17.861C5.684 16.726 5.029 16.421 5.029 16.421C4.121 15.765 5.098 15.777 5.098 15.777C6.101 15.849 6.63 16.844 6.63 16.844C7.521 18.327 8.97 17.908 9.54 17.657C9.628 17.05 9.883 16.632 10.16 16.419C7.93 16.202 5.582 15.353 5.582 11.613C5.582 10.52 6.002 9.628 6.65 8.933C6.55 8.684 6.178 7.658 6.75 6.337C6.75 6.337 7.587 6.073 9.496 7.431C10.295 7.211 11.152 7.102 12 7.098C12.848 7.102 13.705 7.211 14.504 7.431C16.413 6.073 17.25 6.337 17.25 6.337C17.822 7.658 17.45 8.684 17.35 8.933C17.998 9.628 18.418 10.52 18.418 11.613C18.418 15.363 16.068 16.2 13.836 16.413C14.185 16.685 14.512 17.227 14.512 18.043C14.512 19.207 14.499 20.684 14.499 21.012C14.499 21.275 14.677 21.584 15.186 21.487C19.158 20.16 22 16.416 22 12C22 6.477 17.523 2 12 2Z"></path></svg></span> <a href="${data.repoLink || '#'}" style="color: #3982F7; text-decoration: underline;">code</a></p>`
                    }
                  </div>
                </div>
              </div>
              
              <!-- Project Field Details -->
              <div class="project-preview-meta">
                <div>
                  <strong>Type:</strong> ${data.type || 'Not specified'}<br>
                  <strong>Category:</strong> ${data.category || 'Not specified'}<br>
                  <strong>Position:</strong> ${data.position || 'Not specified'}
                </div>
                <div>
                  ${data.authorNames ? `<strong>Authors:</strong> ${data.authorNames}<br>` : ''}
                  ${data.repoLink ? `<strong>Repository:</strong> <a href="${data.repoLink}" target="_blank">${data.repoLink}</a><br>` : ''}
                </div>
              </div>
              
              <div style="margin-top: 15px; padding: 10px; background: #E8F5E9; border-radius: 4px; font-size: 0.9em;">
                <p style="margin: 0; color: #2E7D32;">
                  <strong>Preview Note:</strong> This project will appear in a folder styled interface on the 
                  ${data.category === 'both' ? 'Computer and Research' : data.category} page.
                </p>
              </div>
            </div>
          `;
        } catch (error) {
          return `<div style="color: red; padding: 20px;">Error rendering preview: ${error.message}</div>`;
        }
      });

      // Configure the CMS interface
      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          // Use our wrapper to handle potential Immutable.js errors
          entry = window.fixImmutableIssue(entry);
          
          let data;
          try {
            data = entry.getIn(['data'], {}).toJS();
            console.log('Saving entry data:', data);
          } catch (error) {
            console.error('Error getting entry data in preSave:', error);
            return 'Error processing form data. Please try again.';
          }
          
          // Automatically ensure required fields are present based on project type
          if (data.type === 'written' && !data.authorNames) {
            return 'Written projects require author names. Please add at least one author.';
          }
          if (data.type === 'computational' && !data.repoLink) {
            return 'Computational projects require a repository link. Please add a valid repository URL.';
          }
          
          return true; // Allow the save to proceed
        },
      });

      // Add helpful information to the CMS interface
      document.addEventListener('DOMContentLoaded', function() {
        // Wait for CMS to initialize
        setTimeout(() => {
          const header = document.querySelector('.nc-appHeader-content');
          if (header) {
            const infoButton = document.createElement('button');
            infoButton.className = 'nc-button';
            infoButton.innerHTML = 'Help';
            infoButton.style.marginLeft = '10px';
            infoButton.addEventListener('click', () => {
              alert('Project Management Tips:\n\n• Changes made here are saved to your Git repository\n• To see changes on your site, you must publish them\n• IDs are managed automatically by the application\n• Projects can be reordered in the admin interface\n• Sync your local environment with the CMS using the "Sync with CMS" button');
            });
            header.appendChild(infoButton);
          }
        }, 1000);
      });
    } catch (error) {
      console.error('CMS initialization error:', error);
      alert('Failed to initialize CMS: ' + error.message);
    }
    
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        } else {
          console.log("User is already logged in");
        }
      });
    }
  </script>
</body>
</html> 