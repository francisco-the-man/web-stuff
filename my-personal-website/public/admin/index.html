<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Manager - Content Management System</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Custom styles for better CMS experience */
    :root {
      --primary-color: #3F51B5;
      --secondary-color: #3982F7;
      --success-color: #4CAF50;
      --warning-color: #FF9800;
      --error-color: #F44336;
    }
    
    body {
      font-family: 'IBM Plex Mono', monospace;
    }
    
    /* Make the CMS interface wider */
    .nc-app-main {
      max-width: 1400px !important;
      margin: 0 auto !important;
    }
    
    /* Improved image preview size */
    .nc-imageControl-imageWrapper {
      max-height: 300px;
      overflow: hidden;
    }
    
    /* Style the header */
    .nc-appHeader-main {
      background: var(--primary-color) !important;
    }
    
    /* Custom button styles */
    .nc-button.nc-button-primary {
      background-color: var(--primary-color) !important;
    }
    
    /* Preview styles */
    .project-preview-container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      background: #fff;
    }
    
    .project-preview-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    
    .project-preview-image {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .project-preview-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .project-preview-meta div {
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    
    .project-preview-description {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    /* Info box for path info */
    .info-box {
      margin: 10px 20px;
      padding: 10px;
      background: #E8F5E9;
      border-radius: 4px;
    }
  </style>
  <!-- Import IBM Plex Mono font -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Include the script that builds the page and powers Netlify CMS -->
  <script src="https://unpkg.com/netlify-cms@^2.10.192/dist/netlify-cms.js"></script>
  
  <!-- Initialize the CMS -->
  <script>
    // Global error handling for CMS
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('CMS Error:', message, error);
      return true;
    };

    // Global fix for Immutable.js errors
    (function() {
      // Keep track of patched objects
      const patchedObjects = new WeakMap();
      
      // Monkey patch all methods that might use getIn
      const monkeyPatchMethods = function(obj) {
        if (!obj || typeof obj !== 'object' || patchedObjects.has(obj)) {
          return obj;
        }
        
        // Mark as patched to avoid recursion
        patchedObjects.set(obj, true);
        
        // Add safe getIn method if missing
        if (typeof obj.getIn !== 'function') {
          obj.getIn = function(path, defaultValue) {
            try {
              let current = this;
              
              // Handle empty or invalid paths
              if (!path || !Array.isArray(path)) {
                return defaultValue;
              }
              
              // Traverse the path
              for (const key of path) {
                if (current === undefined || current === null) {
                  return defaultValue;
                }
                
                // Try using get if available, otherwise direct access
                current = typeof current.get === 'function' ? 
                          current.get(key) : current[key];
              }
              
              return current === undefined ? defaultValue : current;
            } catch (e) {
              console.warn('Error in getIn:', e);
              return defaultValue;
            }
          };
        }
        
        // Add toJS method if missing
        if (typeof obj.toJS !== 'function') {
          obj.toJS = function() {
            // Simple conversion to plain object
            return Object.assign({}, this);
          };
        }
        
        return obj;
      };
      
      // Create a more robust error handler for the CMS
      const originalConsoleError = console.error;
      console.error = function(...args) {
        const errorMsg = args.join(' ');
        
        // Check for specific error message
        if (errorMsg.includes('getIn is not a function')) {
          // Try to recover by finding the 't' object in the arguments
          for (let i = 0; i < args.length; i++) {
            if (args[i] && typeof args[i] === 'object') {
              monkeyPatchMethods(args[i]);
            }
          }
        }
        
        // Call original console.error
        originalConsoleError.apply(console, args);
      };
      
      // Global error catcher specifically for getIn errors
      window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && event.reason.message && 
            event.reason.message.includes('getIn is not a function')) {
          console.warn('Caught unhandled rejection with getIn error, patching object');
          
          // Stop propagation and prevent default
          event.stopImmediatePropagation();
          event.preventDefault();
          
          // Try to recover
          setTimeout(function() {
            const buttons = document.querySelectorAll('button');
            const saveButton = Array.from(buttons).find(b => 
              b.textContent.toLowerCase().includes('save') || 
              b.textContent.toLowerCase().includes('publish')
            );
            
            if (saveButton) {
              console.log('Attempting to retry save operation...');
              saveButton.click();
            }
          }, 500);
          
          return false;
        }
      });
      
      // Global method to fix Immutable objects
      window.fixImmutableIssue = function(entry) {
        if (!entry) return { 
          getIn: () => undefined, 
          toJS: () => ({}), 
          data: {} 
        };
        
        return monkeyPatchMethods(entry);
      };
    })();

    // Initialize Netlify CMS with error handling
    try {
      // Configure the CMS before init
      CMS.init({
        config: {
          load_config_file: true
        }
      });
      console.log('CMS initialized successfully');
      
      // Register a custom preview template for projects
      CMS.registerPreviewTemplate('projects', ({ entry }) => {
        // Use our wrapper to handle potential Immutable.js errors
        entry = window.fixImmutableIssue(entry);
        
        let data;
        try {
          data = entry.getIn(['data'], {});
          data = typeof data.toJS === 'function' ? data.toJS() : data;
        } catch (error) {
          console.error('Error getting entry data:', error);
          data = {};
        }
        
        try {
          // Validate required fields based on type
          if (data.type === 'written' && !data.authorNames) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Written projects require author names. Please add at least one author.</p>
              </div>
            `;
          }
          if (data.type === 'computational' && !data.repoLink) {
            return `
              <div style="color: #F44336; padding: 20px; text-align: center; background: #FFEBEE; border-radius: 4px;">
                <h3>Missing Required Field</h3>
                <p>Computational projects require a repository link. Please add a valid repository URL.</p>
              </div>
            `;
          }
          
          // Preview the project data with improved styling
          return `
            <div class="project-preview-container">
              <div class="project-preview-header">
                <h1 style="margin-top: 0; color: #333;">${data.projectTitle || 'Untitled Project'}</h1>
                <p style="color: #666; margin-bottom: 0;">
                  <strong>Tab Label:</strong> ${data.fileName || 'Unnamed Tab'}
                </p>
              </div>
              
              <!-- Project Folder Preview -->
              <div style="position: relative; width: 100%; margin: 30px 0; border: 1px solid #eee; border-radius: 8px; padding: 20px; background: #f9f9f9;">
                <div style="position: absolute; top: -15px; left: 40px; background: #fff; padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px;">
                  ${data.fileName || 'Unnamed Tab'}
                </div>
                
                <div style="text-align: center; margin-top: 10px;">
                  <h3 style="text-transform: uppercase; font-weight: bold; margin-bottom: 15px;">${data.projectTitle || 'Untitled Project'}</h3>
                  
                  <div style="width: 80%; margin: 0 auto 15px auto;">
                    ${data.projectImg ? 
                      `<img src="${data.projectImg}" alt="${data.projectTitle}" style="width: 100%; height: 140px; object-fit: cover; border: 1px solid #ddd;" />` : 
                      '<div style="width: 100%; height: 140px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd;"><span>No Image Selected</span></div>'
                    }
                  </div>
                  
                  <p style="font-size: 14px; margin-bottom: 20px; min-height: 60px; line-height: 1.5;">
                    ${data.description || 'No description provided.'}
                  </p>
                  
                  <div style="margin-top: auto; text-align: center; padding-top: 10px; border-top: 1px solid #eee;">
                    ${data.type === 'written' ? 
                      `<p style="font-style: italic; font-size: 12px;">written by: ${data.authorNames || 'unknown'}</p>` : 
                      `<p style="font-size: 12px;"><span style="display: inline-block; vertical-align: middle; margin-right: 5px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12C2 16.418 4.865 20.166 8.84 21.489C9.34 21.579 9.52 21.273 9.52 21.012C9.52 20.775 9.512 20.136 9.508 19.3C6.726 19.91 6.14 17.861 6.14 17.861C5.684 16.726 5.029 16.421 5.029 16.421C4.121 15.765 5.098 15.777 5.098 15.777C6.101 15.849 6.63 16.844 6.63 16.844C7.521 18.327 8.97 17.908 9.54 17.657C9.628 17.05 9.883 16.632 10.16 16.419C7.93 16.202 5.582 15.353 5.582 11.613C5.582 10.52 6.002 9.628 6.65 8.933C6.55 8.684 6.178 7.658 6.75 6.337C6.75 6.337 7.587 6.073 9.496 7.431C10.295 7.211 11.152 7.102 12 7.098C12.848 7.102 13.705 7.211 14.504 7.431C16.413 6.073 17.25 6.337 17.25 6.337C17.822 7.658 17.45 8.684 17.35 8.933C17.998 9.628 18.418 10.52 18.418 11.613C18.418 15.363 16.068 16.2 13.836 16.413C14.185 16.685 14.512 17.227 14.512 18.043C14.512 19.207 14.499 20.684 14.499 21.012C14.499 21.275 14.677 21.584 15.186 21.487C19.158 20.16 22 16.416 22 12C22 6.477 17.523 2 12 2Z"></path></svg></span> <a href="${data.repoLink || '#'}" style="color: #3982F7; text-decoration: underline;">code</a></p>`
                    }
                  </div>
                </div>
              </div>
              
              <!-- Project Field Details -->
              <div class="project-preview-meta">
                <div>
                  <strong>Type:</strong> ${data.type || 'Not specified'}<br>
                  <strong>Category:</strong> ${data.category || 'Not specified'}<br>
                  <strong>Position:</strong> ${data.position || 'Not specified'}
                </div>
                <div>
                  ${data.authorNames ? `<strong>Authors:</strong> ${data.authorNames}<br>` : ''}
                  ${data.repoLink ? `<strong>Repository:</strong> <a href="${data.repoLink}" target="_blank">${data.repoLink}</a><br>` : ''}
                </div>
              </div>
              
              <div style="margin-top: 15px; padding: 10px; background: #E8F5E9; border-radius: 4px; font-size: 0.9em;">
                <p style="margin: 0; color: #2E7D32;">
                  <strong>Preview Note:</strong> This project will appear in a folder styled interface on the 
                  ${data.category === 'both' ? 'Computer and Research' : data.category} page.
                </p>
              </div>
            </div>
          `;
        } catch (error) {
          return `<div style="color: red; padding: 20px;">Error rendering preview: ${error.message}</div>`;
        }
      });

      // Register event listeners for validation and data handling
      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          try {
            // Apply our Immutable fix
            entry = window.fixImmutableIssue(entry);
            
            // Get and validate entry data
            let data;
            try {
              data = entry.getIn(['data'], {});
              data = typeof data.toJS === 'function' ? data.toJS() : data;
            } catch (error) {
              console.error('Error getting entry data in preSave:', error);
              return 'Error processing form data. Please try again.';
            }
            
            // Validate required fields
            if (!data.fileName) {
              return 'File Name is required. Please provide a tab name.';
            }
            
            if (data.type === 'written' && !data.authorNames) {
              return 'Written projects require author names. Please add at least one author.';
            }
            
            if (data.type === 'computational' && !data.repoLink) {
              return 'Computational projects require a repository link. Please add a valid repository URL.';
            }
            
            return true; // Allow the save to proceed
          } catch (error) {
            console.error('Error in preSave handler:', error);
            return 'An unexpected error occurred. Please try again or check the console for details.';
          }
        },
      });
      
      // Fix potential issues with entry loading
      CMS.registerEventListener({
        name: 'prePublish',
        handler: ({ entry }) => {
          // Patch the entry one more time right before publishing
          window.fixImmutableIssue(entry);
          return true;
        }
      });

      // Add helpful information to the CMS interface
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          try {
            // Add info box about project paths
            const content = document.querySelector('.nc-app-main .nc-app-content');
            if (content) {
              const infoBox = document.createElement('div');
              infoBox.className = 'info-box';
              infoBox.innerHTML = `
                <h3 style="margin-top: 0;">Project Management Details</h3>
                <p><strong>Projects are saved to:</strong> src/_projects/[timestamp].json</p>
                <p><strong>Images are saved to:</strong> public/projects/images/</p>
                <p><strong>File Name field</strong> is used for the folder tab label.</p>
                <p><strong>Note:</strong> We've switched to timestamp-based filenames for better compatibility.</p>
              `;
              
              // Insert at the beginning of the content
              if (content.firstChild) {
                content.insertBefore(infoBox, content.firstChild);
              } else {
                content.appendChild(infoBox);
              }
            }
            
            // Add debug info buttons
            const header = document.querySelector('.nc-appHeader-content');
            if (header) {
              const infoButton = document.createElement('button');
              infoButton.className = 'nc-button';
              infoButton.innerHTML = 'Help';
              infoButton.style.marginLeft = '10px';
              infoButton.addEventListener('click', () => {
                alert('Project Management Tips:\n\n• Changes made here are saved to your Git repository\n• To see changes on your site, you must publish them\n• File Name field is used for the folder tab display\n• Projects can be reordered in the admin interface\n• Check the console (F12) for additional error information if issues occur');
              });
              header.appendChild(infoButton);
              
              // Add debugging info button
              const debugButton = document.createElement('button');
              debugButton.className = 'nc-button';
              debugButton.innerHTML = 'Debug Info';
              debugButton.style.marginLeft = '10px';
              debugButton.style.background = '#FF9800';
              debugButton.addEventListener('click', () => {
                console.log('CMS Config:', CMS.getConfig());
                alert('Debug information has been output to the browser console.\nPress F12 to view.');
              });
              header.appendChild(debugButton);
              
              // Add patch status checker button
              const checkButton = document.createElement('button');
              checkButton.className = 'nc-button';
              checkButton.innerHTML = 'Check Patches';
              checkButton.style.marginLeft = '10px';
              checkButton.style.background = '#2196F3';
              checkButton.addEventListener('click', () => {
                // Try to apply patches again
                const cms = window.CMS;
                if (cms && cms.getState) {
                  const state = cms.getState();
                  console.log('Current CMS state:', state);
                  
                  // Check for entries collection
                  if (state.entries && state.entries.entities) {
                    const entries = state.entries.entities;
                    console.log('Found', Object.keys(entries).length, 'entries');
                    
                    // Try to apply our patches to all entries
                    Object.values(entries).forEach(entry => {
                      window.fixImmutableIssue(entry);
                    });
                    
                    alert('Patches have been reapplied to ' + Object.keys(entries).length + ' entries.');
                  } else {
                    alert('No entries found in CMS state.');
                  }
                } else {
                  alert('Unable to access CMS state.');
                }
              });
              header.appendChild(checkButton);
            }
          } catch (e) {
            console.error('Error adding help elements:', e);
          }
        }, 1000);
      });
      
      // Attempt to patch any existing objects in the CMS at regular intervals
      setInterval(function() {
        try {
          // Find all forms in the DOM
          const forms = document.querySelectorAll('form');
          forms.forEach(form => {
            // Find all input elements
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
              // Check if the input has an associated CMS widget
              const widget = input.closest('[class*="widget-"]');
              if (widget && widget.__cms_widget) {
                window.fixImmutableIssue(widget.__cms_widget);
              }
            });
          });
        } catch (e) {
          // Silently fail, this is just a precaution
        }
      }, 2000);
    } catch (error) {
      console.error('CMS initialization error:', error);
      alert('Failed to initialize CMS: ' + error.message);
    }
  </script>
</body>
</html> 